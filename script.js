const pixelData = [
    {
        "name": "blank",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "00000000",
                    "00000000",
                    "00000000",
                    "00000000",
                    "00000000",
                    "00000000",
                    "00000000"
                ]
            }
        ]
    },
    {
        "name": "0",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "00111000",
                    "01001100",
                    "11000110",
                    "11000110",
                    "11000110",
                    "01100100",
                    "00111000"
                ]
            }
        ]
    },
   {
        "name": "1",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "00011000",
                    "00111000",
                    "00011000",
                    "00011000",
                    "00011000",
                    "00011000",
                    "01111110"
                ]
            }
        ]
    },
    {
        "name": "2",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "01111100",
                    "11000110",
                    "00001110",
                    "00111100",
                    "01111000",
                    "11100000",
                    "11111110"
                ]
            }
        ]
    },
    {
        "name": "3",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "01111110",
                    "00001100",
                    "00011000",
                    "00111100",
                    "00000110",
                    "11000110",
                    "01111100"
                ]
            }
        ]
    },
    {
        "name": "4",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "00011100",
                    "00111100",
                    "01101100",
                    "11001100",
                    "11111110",
                    "00001100",
                    "00001100"
                ]
            }
        ]
    },
    {
        "name": "5",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "11111100",
                    "11000000",
                    "11111100",
                    "00000110",
                    "00000110",
                    "11000110",
                    "01111100"
                ]
            }
        ]
    },
    {
        "name": "6",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "00111100",
                    "01100000",
                    "11000000",
                    "11111100",
                    "11000110",
                    "11000110",
                    "01111100"
                ]
            }
        ]
    },
    {
        "name": "7",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "11111110",
                    "11000110",
                    "00001100",
                    "00011000",
                    "00110000",
                    "00110000",
                    "01100000"
                ]
            }
        ]
    },
    {
        "name": "8",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "01111000",
                    "11000100",
                    "11100100",
                    "01111000",
                    "10011110",
                    "10000110",
                    "01111100"
                ]
            }
        ]
    },
        {
        "name": "9",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "00000000",
                    "01111100",
                    "11000110",
                    "11000110",
                    "01111110",
                    "00000110",
                    "00001100",
                    "01111000"
                ]
            }
        ]
    },
    {
        "name": "colon",
        "type": "digit",
        "shape": [
            {
                "frameName": 1,
                "grid": [
                    "0",
                    "0",
                    "L",
                    "L",
                    "0",
                    "L",
                    "L",
                    "0"
                ]
            }
        ]
    },
    {
        "name": "ghost-blinky",
        "type": "animation",
        "shape": [
            {
                "frameName": 0,
                "grid": [
                    "0000000000000000",
                    "000000RRRR000000",
                    "0000RRRRRRRR0000",
                    "000RRRRRRRRRR000",
                    "00RRRRRRRRRRRR00",
                    "00RRRWWRRRRWWR00",
                    "00RRWWWWRRWWWW00",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRRWWRRRRWWRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRR0RRRR0RRRR0",
                    "00RR000RR000RR00",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 1,
                "grid": [
                    "0000000000000000",
                    "000000RRRR000000",
                    "0000RRRRRRRR0000",
                    "000RRRRRRRRRR000",
                    "00RRRRRRRRRRRR00",
                    "00RRRWWRRRRWWR00",
                    "00RRWWWWRRWWWW00",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRRWWRRRRWWRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRR0RRRR0RRRR0",
                    "00RR000RR000RR00",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 2,
                "grid": [
                    "0000000000000000",
                    "000000RRRR000000",
                    "0000RRRRRRRR0000",
                    "000RRRRRRRRRR000",
                    "00RRRRRRRRRRRR00",
                    "00RRRWWRRRRWWR00",
                    "00RRWWWWRRWWWW00",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRRWWRRRRWWRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RR0RRR00RRR0RR0",
                    "0R000RR00RR000R0",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 3,
                "grid": [
                    "0000000000000000",
                    "000000RRRR000000",
                    "0000RRRRRRRR0000",
                    "000RRRRRRRRRR000",
                    "00RRRRRRRRRRRR00",
                    "00RRRWWRRRRWWR00",
                    "00RRWWWWRRWWWW00",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRWWBBRRWWBBR0",
                    "0RRRRWWRRRRWWRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RRRRRRRRRRRRRR0",
                    "0RR0RRR00RRR0RR0",
                    "0R000RR00RR000R0",
                    "0000000000000000"
                ]
            },
        ]
    },
    {
        "name": "ghost-pinky",
        "type": "animation",
        "shape": [
            {
                "frameName": 0,
                "grid": [
                    "0000000000000000",
                    "000000PPPP000000",
                    "0000PPPPPPPP0000",
                    "000PPPPPPPPPP000",
                    "00PPPPPPPPPPPP00",
                    "00PPPWWPPPPWWP00",
                    "00PPWWWWPPWWWW00",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPPWWPPPPWWPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPP0PPPP0PPPP0",
                    "00PP000PP000PP00",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 1,
                "grid": [
                    "0000000000000000",
                    "000000PPPP000000",
                    "0000PPPPPPPP0000",
                    "000PPPPPPPPPP000",
                    "00PPPPPPPPPPPP00",
                    "00PPPWWPPPPWWP00",
                    "00PPWWWWPPWWWW00",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPPWWPPPPWWPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPP0PPPP0PPPP0",
                    "00PP000PP000PP00",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 2,
                "grid": [
                    "0000000000000000",
                    "000000PPPP000000",
                    "0000PPPPPPPP0000",
                    "000PPPPPPPPPP000",
                    "00PPPPPPPPPPPP00",
                    "00PPPWWPPPPWWP00",
                    "00PPWWWWPPWWWW00",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPPWWPPPPWWPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PP0PPP00PPP0PP0",
                    "0P000PP00PP000P0",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 3,
                "grid": [
                    "0000000000000000",
                    "000000PPPP000000",
                    "0000PPPPPPPP0000",
                    "000PPPPPPPPPP000",
                    "00PPPPPPPPPPPP00",
                    "00PPPWWPPPPWWP00",
                    "00PPWWWWPPWWWW00",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPWWBBPPWWBBP0",
                    "0PPPPWWPPPPWWPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PPPPPPPPPPPPPP0",
                    "0PP0PPP00PPP0PP0",
                    "0P000PP00PP000P0",
                    "0000000000000000"
                ]
            },
        ]
    },
    {
        "name": "pac-man",
        "type": "animation",
        "shape": [
            {
                "frameName": 0,
                "grid": [
                    "0000000000000000",
                    "000000YYYYY00000",
                    "0000YYYYYYY00000",
                    "000YYYYYYY000000",
                    "000YYYYYY0000000",
                    "00YYYYYY00000000",
                    "00YYYYY000000000",
                    "00YYYY0000000000",
                    "00YYYYY000000000",
                    "00YYYYYY00000000",
                    "000YYYYYY0000000",
                    "000YYYYYYY000000",
                    "0000YYYYYYY00000",
                    "000000YYYYY00000",
                    "0000000000000000",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 1,
                "grid": [
                    "0000000000000000",
                    "000000YYYYY00000",
                    "0000YYYYYYYYY000",
                    "000YYYYYYYYYYY00",
                    "000YYYYYYYYYYY00",
                    "00YYYYYYYYYY0000",
                    "00YYYYYYY0000000",
                    "00YYYYY000000000",
                    "00YYYYYYY0000000",
                    "00YYYYYYYYYY0000",
                    "000YYYYYYYYYYY00",
                    "000YYYYYYYYYYY00",
                    "0000YYYYYYYYY000",
                    "000000YYYYY00000",
                    "0000000000000000",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 2,
                "grid": [
                    "0000000000000000",
                    "000000YYYYY00000",
                    "0000YYYYYYYYY000",
                    "000YYYYYYYYYYY00",
                    "000YYYYYYYYYYY00",
                    "00YYYYYYYYYYYYY0",
                    "00YYYYYYYYYYYYY0",
                    "00YYYYYYYYYYYYY0",
                    "00YYYYYYYYYYYYY0",
                    "00YYYYYYYYYYYYY0",
                    "000YYYYYYYYYYY00",
                    "000YYYYYYYYYYY00",
                    "0000YYYYYYYYY000",
                    "000000YYYYY00000",
                    "0000000000000000",
                    "0000000000000000"
                ]
            },
            {
                "frameName": 3,
                "grid": [
                    "0000000000000000",
                    "000000YYYYY00000",
                    "0000YYYYYYYYY000",
                    "000YYYYYYYYYYY00",
                    "000YYYYYYYYYYY00",
                    "00YYYYYYYYYY0000",
                    "00YYYYYYY0000000",
                    "00YYYYY000000000",
                    "00YYYYYYY0000000",
                    "00YYYYYYYYYY0000",
                    "000YYYYYYYYYYY00",
                    "000YYYYYYYYYYY00",
                    "0000YYYYYYYYY000",
                    "000000YYYYY00000",
                    "0000000000000000",
                    "0000000000000000"
                ]
            },
            
        ]
    }
];

// Grid dimensions and offsets
var xWidth = 32;
var yHeight = 16;
var yOffset = 3; // Vertical offset to center digits in grid
var startX = 1; // Initial horizontal position
var characterSpeed = 40; // Speed of animation in milliseconds

// Positions for each digit
var place1 = -1;
var place2 = 7;
var place3 = 15;
var place4 = 17;
var place5 = 25;

// Get containers
var clockGridContainer = document.querySelector('.clock-grid');
var characterGridContainer = document.getElementById('character-grid');

createPixelGrid(clockGridContainer, "bottom"); // Create bottom panel grid for clock numbers
createPixelGrid(characterGridContainer, "top"); // Create top panel grid for characters
printCharToPanel("colon", place3, "bottom"); // Print colon to the bottom panel

// Update time
displayTimeDigits(); // Initial display of time
var a = setInterval(() => {
    displayTimeDigits();
    const userSetWidth = clockGridContainer.offsetWidth;
    clockGridContainer.style.height = `${userSetWidth / 2}px`;
    getAndSetPixelSize(); // Adjust pixel sizes to be square
}, 1000);


countDownToGroupRelease(); // Start countdown to release characters

function countDownToGroupRelease() {
    var characterTimer = setInterval(() => {
        let now = new Date();
        let seconds = now.getSeconds();
        if (seconds % 15 === 0) {
            releaseTheGroup();
            clearInterval(characterTimer); // Clear interval to prevent multiple triggers
            setTimeout(() => {
                countDownToGroupRelease(); // Restart countdown for next release
            }, 1001);
        }
    }, 500);
}


function animateCharacter(characterName="pac-man", direction="right") {
    let frameCount = getPixelDataByName(characterName).shape.length; // Get number of frames for the character
    var charFrame = 0;

    // Set starting position based on direction
    if (direction === "right") {
        var pos = -15;
    } else if (direction === "left") {
        var pos = xWidth;
    } else {
        var pos = -15;
        direction = "right";
    }

    // Start animation interval based on direction
    if (direction === "right") {
        var characters = setInterval(() => {
            if (pos < xWidth) {
                printCharToPanel(characterName, pos, "top", charFrame);
                pos++;
                if (charFrame < frameCount - 1) {
                    charFrame++;
                } else {
                    charFrame = 0;
                }
            } else {
                clearInterval(characters);
            }
        }, characterSpeed);
    } else if (direction === "left") {
        var characters = setInterval(() => {
            if (pos > -16) {
                printCharToPanel(characterName, pos, "top", charFrame);
                pos--;
                
                // Advance to next frame for that specific character
                if (charFrame < frameCount - 1) {
                    charFrame++;
                } else {
                    charFrame = 0;
                }
            } else {
                clearInterval(characters);
            }
        }, characterSpeed);
    }
}

function releaseTheGroup(powerUp=false) {
    let characterReleaseDelay = characterSpeed * 16; // Delay before first character is released
    let delayAfterPacMan = 600;
    animateCharacter("pac-man", "right"); // Release Pac-Man

    if (powerUp) {
        var ghost1 = "ghost-frightened";
        var ghost2 = "ghost-frightened";
        var ghost3 = "ghost-frightened";
        var ghost4 = "ghost-frightened";
        var direction = "left";
    } else {
        var ghost1 = "ghost-blinky";
        var ghost2 = "ghost-pinky";
        var ghost3 = "ghost-blinky";
        var ghost4 = "ghost-blinky";
        var direction = "right";
    }

    setTimeout(() => {
        animateCharacter(ghost1, direction);
    }, characterReleaseDelay + delayAfterPacMan);

    setTimeout(() => {
        animateCharacter(ghost2, direction);
    }, characterReleaseDelay * 2 + delayAfterPacMan);
    
    setTimeout(() => {
        animateCharacter(ghost3, direction);
    }, characterReleaseDelay * 3 + delayAfterPacMan);

    setTimeout(() => {
        animateCharacter(ghost4, direction);
    }, characterReleaseDelay * 4 + delayAfterPacMan);

}

function displayTimeDigits() {
    let now = new Date();
    let hours24 = now.getHours();
    let hours12 = (hours24 % 12) || 12;
    let hours = hours12.toString().padStart(2, '0');
    let minutes = now.getMinutes().toString().padStart(2, '0');

    let firstHourDigit = hours.charAt(0);
    let secondhourDigit = hours.charAt(1)
    let firstMinuteDigit = minutes.charAt(0);
    let secondMinuteDigit = minutes.charAt(1);

    if (firstHourDigit != "0") { // Only print first hour digit if it's not zero
        printCharToPanel(firstHourDigit, place1, "bottom");
    } else {
        printCharToPanel("blank", place1, "bottom"); // Print blank for leading zero
    }
    printCharToPanel(secondhourDigit, place2, "bottom");
    printCharToPanel(firstMinuteDigit, place4, "bottom");
    printCharToPanel(secondMinuteDigit, place5, "bottom");    
}

function printCharToPanel(charName, digitPlace, panelName, chosenFrame=0) {
    let digitData = getPixelDataByName(charName);
    // console.log(digitData.shape.length); // Log number of frames
    let shape = digitData.shape[chosenFrame].grid


    for (let y = 0; y < shape.length; y++) { // Loop through rows
        for (let x = 0; x < shape[y].length; x++) { // Loop through columns

            var pixelChar = shape[y][x];

            // Adjust y position for digits to center them vertically
            if (digitData.type === "digit") {
                var startY = y + yOffset;
            } else {
                var startY = y;
            }

            startX = x + digitPlace; // Adjust x position based on digit place


            // Set pixel classes based on character
            try { // added try-catch to prevent errors when accessing out-of-bounds pixels
                let pixelElement = document.getElementById(`${panelName}-${startX}-${startY}`);
                if (pixelChar === "0") {
                    pixelElement.className = 'pixel pixel-blank';
                } else if (pixelChar === "1") {
                    pixelElement.className = 'pixel pixel-white';
                } else if (pixelChar === "L") {
                    pixelElement.className = 'pixel pixel-colon';
                } else if (pixelChar === "R") {
                    pixelElement.className = 'pixel pixel-red';
                } else if (pixelChar === "P") {
                    pixelElement.className = 'pixel pixel-pink';
                } else if (pixelChar === "B") {
                    pixelElement.className = 'pixel pixel-blue';
                } else if (pixelChar === "Y") {
                    pixelElement.className = 'pixel pixel-yellow';
                } else if (pixelChar === "W") {
                    pixelElement.className = 'pixel pixel-white';
                }
            } catch (error) {
                // console.log("Pixel missing: " + `${panelName}: ${startX}-${startY}`);
            } 




        }
    }
}

function createPixelGrid(container, name) {
    for (let y = 0; y < yHeight; y++) {
        let pixelRow = document.createElement('div');
        pixelRow.id = `${y+1}`;
        pixelRow.classList.add('pixel-row');
        for (let x = 0; x < xWidth; x++) {
            let pixel = document.createElement('div');
            pixel.classList.add('pixel');
            pixel.id = `${name}-${x}-${y}`;
            pixelRow.appendChild(pixel);
        }
        container.appendChild(pixelRow);
    }
}

function getPixelDataByName(name) {
    for (let i = 0; i < pixelData.length; i++) {
        if (pixelData[i].name === name) {
            return pixelData[i];
        }
    }
    return null;
}

function getAndSetPixelSize() {
    const allPixels = document.querySelectorAll('.pixel');
    const pixel = document.querySelector('.pixel');
    const pixelWidth = pixel.offsetWidth;


    allPixels.forEach(div => {
        div.style.height = pixelWidth + "px";
    });
}






